---
title: '源码部署'
sidebar_position: 1
---

# 🛠 源码部署

## 1. 环境及组件要求

对于服务器环境、系统、以及所依赖组件的说明可以参考[此文档](./env-comp)

## 2. 部署 OpenIM Server (IM)

### 2.1 clone 仓库 建议切换到 release-v3.8.2 分支

```
git clone https://github.com/openimsdk/open-im-server && cd open-im-server
```

### 2.2 部署组件 (mongodb/redis/kafka/MinIO)

```
docker compose up -d
```

如需启动监控组件(prometheus/alertmanager/grafana)

```sh
docker compose --profile m up -d
```

监控告警使用参考： [监控告警](./admin.mdx)

### 2.3 设置外网 IP 或域名[参考 Nginx 配置](./nginxDomainConfig.mdx)

```
修改 config/minio.yml 中的 externalAddress 为 http://外网IP:port 或 域名
```

### 2.4 🛠️ 初始化

第一次编译前，linux/mac 平台下执行：

```
bash bootstrap.sh
```

windows 执行

```
bootstrap.bat
```

### 2.5 🛠️ 编译(linux/windows/mac 平台均可用)

```
mage
```

### 2.6 🚀 启动/停止/检测(linux/windows/mac 平台均可用)

```
# 启动
mage start
# 或 后台启动 收集日志
nohup mage start >> _output/logs/openim.log 2>&1 &
# 停止
mage stop
# 检测
mage check
```

## 3. 部署 App Server (Chat)

### 3.1 clone 仓库 建议切换到 release-v1.8 分支

```
git clone https://github.com/openimsdk/chat&& cd chat
```

### 3.2 🛠️ 初始化

第一次编译前，linux/mac 平台下执行：

```
bash bootstrap.sh
```

windows 执行

```
bootstrap.bat
```

### 3.3 🛠️ 编译(linux/windows/mac 平台均可用)

```
mage
```

### 3.4 🚀 启动/停止/检测(linux/windows/mac 平台均可用)

```
# 启动
mage start
# 或 后台启动 收集日志
nohup mage start >> _output/logs/chat.log 2>&1 &
# 停止
mage stop
# 检测
mage check

```

---

## 4. 快速验证

请参考[快速验证](./quickTestServer)文档

---

## 5. 管理后台和监控系统

请参考 [管理后台和监控系统](./admin) 文档。

---

## 6. 关于配置项的修改

[参考此文档](../../restapi/commonConfigs.mdx)

---

## 7. 常见问题

### 7.1 📜 日志查看

日志位置：

- IM：`_output/logs/openim-service-log.*`
- Chat：`_output/logs/openim-chat-log.*`

### 7.2 🚀 启动顺序

启动顺序如下：

- IM 依赖的组件：mongo/redis/kafka/minio 等
- **IM**
- **Chat**

### 7.3 🐳 Docker 版本

新版 Docker 已经整合了 docker-compose. 老版本的 Docker 可能不支持 gateway 功能 ❌。我们建议您升级到较新的版本，例如 `23.0.1`🔝

## ❓ 8.常见问题

### 1.能正常发送文本消息，但发送图片失败 😕

可能是因为没有在执行 `docker compose up -d` 命令之前设置 `OPENIM_IP` 环境变量。可以通过查看启动时日志，或使用以下命令搜索日志中的 "127.0.0.1" 地址来确认：

```bash
grep "127.0.0.1" openim-server/_output/logs/openim-docker.log
```

#### 解决方案：

1. 设置 `OPENIM_IP` 环境变量为你的公网IP地址，如仅提供内网服务则为内网IP地址：

   ```bash
   export OPENIM_IP="<Public-IP>"
   ```

2. 使用 `sed` 命令更新 `config.yaml` 文件中的 `apiURL` 和 `signEndpoint` 配置项，将地址改为使用 `OPENIM_IP` 环境变量指定的IP地址：

   ```bash
   sed -i -e "s/apiURL: \"http:\/\/127\.0\.0\.1/apiURL: \"http:\/\/${OPENIM_IP}/" \
          -e "s/signEndpoint: \"http:\/\/127\.0\.0\.1/signEndpoint: \"http:\/\/${OPENIM_IP}/" \
          openim-server/config/config.yaml
   ```

通过上述步骤修改配置并重启服务后，应能正常发送图片消息。
